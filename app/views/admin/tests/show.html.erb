<% content_for(:title) { "EIS | #{@test.title}" } %>
<% content_for :hero do %>
    <div class="layout--hero">
        <h1><%= @test.title %></h1>
        <%= back_link(text: t('.back_to_tests'), path: admin_tests_path) %>
    </div>
<% end %>

<div class="page page--admin-test-show">
  <div class="page--header">
    <div class="wrapper">
      <div class="row center-xs">
        <div class="col-xs-auto">
          <%= link_to t(:edit), edit_admin_test_path(@test), class: 'button button--secondary' %>
        </div>
        <div class="col-xs-auto">
          <% if @test.active? %>
            <%= link_to t(:deactivate), deactivate_admin_test_path(@test),  
                        class: 'button button--error',
                        data: { turbo: true, turbo_method: :patch, turbo_confirm: t('.confirm_deactivate') } %>
          <% else %>
            <%= link_to t(:activate), activate_admin_test_path(@test),
                        data: { turbo: true, turbo_method: :patch, turbo_confirm: t('.confirm_activate') },
                        class: 'button button--success' %>
          <% end %>
        </div>
        <div class="col-xs-auto">
          <%= link_to t(:duplicate), duplicate_admin_test_path(@test),
                      class: 'button button--secondary',
                      data: { turbo: true, turbo_method: :post, turbo_confirm: t('.confirm_duplicate') } %>
        </div>
        <div class="col-xs-auto">
          <%= link_to t(:assign), new_admin_test_test_attempt_path(@test), class: 'button button--secondary' %>
        </div>
        <div class="col-xs-auto">
          <%= link_to t(:delete), admin_test_path(@test),
                      class: 'button button--danger',
                      data: { turbo: true, turbo_method: :delete, turbo_confirm: t('.confirm_delete') } %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="wrapper">
    <div class="row">
      <div class="col-md-6 col-xs-12">
        <div class="paper">
          <div class="paper--header">
            <h3><%= t('.test_information') %></h3>
            <div class="test-status">
              <% if @test.active? %>
                <span class="label label-success"><%= t('.active') %></span>
              <% else %>
                <span class="label label-default"><%= t('.inactive') %></span>
              <% end %>
            </div>
          </div>
          
          <div class="paper--content">
            <div class="info-section">
              <h4><%= t('.descriptions') %></h4>
              <div class="description-pair">
                <div class="description-item">
                  <strong><%= t('.estonian') %>:</strong>
                  <p><%= @test.description_et %></p>
                </div>
                <div class="description-item">
                  <strong><%= t('.english') %>:</strong>
                  <p><%= @test.description_en %></p>
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <h4><%= t('.test_configuration') %></h4>
              <div class="config-grid">
                <div class="config-item">
                  <span class="config-label"><%= t('.test_type') %>:</span>
                  <span class="config-value">
                    <span class="label label-<%= @test.test_type == 'theoretical' ? 'info' : 'warning' %>">
                      <%= t(".#{@test.test_type}") %>
                    </span>
                  </span>
                </div>
                <div class="config-item">
                  <span class="config-label"><%= t('admin.tests.index.time_limit') %>:</span>
                  <span class="config-value"><%= @test.time_limit_minutes %> <%= t(:minutes) %></span>
                </div>
                <div class="config-item">
                  <span class="config-label"><%= t('admin.tests.index.passing_score') %>:</span>
                  <span class="config-value"><%= @test.passing_score_percentage %>%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    
      <div class="col-md-6 col-xs-12">
        <div class="paper">
          <div class="paper--header">
            <h3><%= t('.statistics') %></h3>
          </div>
          
          <div class="paper--content">
            <div class="stats-grid">
              <% if @test.has_theoretical_questions? %>
                <div class="stat-item">
                  <span class="stat-label"><%= t('.categories') %></span>
                  <span class="stat-value"><%= @test_categories.count %></span>
                </div>
                <div class="stat-item">
                  <span class="stat-label"><%= t('.total_questions') %></span>
                  <span class="stat-value"><%= @test.theoretical_questions_count %></span>
                </div>
              <% end %>
              <% if @test.has_practical_tasks? %>
                <div class="stat-item">
                  <span class="stat-label"><%= t('.practical_tasks') %></span>
                  <span class="stat-value"><%= @test.practical_tasks_count %></span>
                </div>
              <% end %>
              <div class="stat-item">
                <span class="stat-label"><%= t('.total_components') %></span>
                <span class="stat-value"><%= @test.total_components %></span>
              </div>
              <div class="stat-item">
                <span class="stat-label"><%= t('.total_attempts') %></span>
                <span class="stat-value"><%= link_to_if @test.test_attempts.count.positive?, @test.test_attempts.count, admin_test_test_attempts_path(@test) %></span>
              </div>
              <div class="stat-item">
                <span class="stat-label"><%= t('.passed_attempts') %></span>
                <span class="stat-value"><%= @test.test_attempts.passed.count %></span>
              </div>
              <div class="stat-item">
                <span class="stat-label"><%= t('.failed_attempts') %></span>
                <span class="stat-value"><%= @test.test_attempts.failed.count %></span>
              </div>
              <div class="stat-item">
                <span class="stat-label"><%= t('.pass_rate') %></span>
                <span class="stat-value">
                  <% if @test.test_attempts.count > 0 %>
                    <%= number_to_percentage((@test.test_attempts.passed.count.to_f / @test.test_attempts.count * 100), precision: 1) %>
                  <% else %>
                    <%= t('.no_attempts') %>
                  <% end %>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <% if @test.has_theoretical_questions? %>
      <div class="row test-categories-section">
        <div class="col-md-12 col-xs-12">
          <div class="paper">
            <div class="paper--header">
              <h3><%= t('.categories') %></h3>
            </div>
            <div class="paper--content">
              <div class="categories-grid" data-controller="drag" data-drag-url-value="<%= update_positions_admin_test_test_categories_tests_path(@test) %>">
                <% @test_categories.each do |category| %>
                  <div class="category-card item" data-id="<%= category.test_categories_test_id %>">
                    <div class="category-header">
                      <h4>
                        <i class="fas fa-grip-vertical drag-handle"></i>
                        <%= link_to category.name, admin_test_category_path(category) %>
                      </h4>
                      <div class="category-actions">      
                        <%= link_to t('.edit'), edit_admin_test_category_path(category), class: 'button button--link' %>
                      </div>
                    </div>
                    <div class="category-details">
                      <p><%= category.description %></p>
                      <div class="category-meta">
                        <span><%= t('.questions') %>: <%= category.questions.count %></span>  
                        <span><%= t('.domain_rule') %>: <%= link_to_if category.domain_rule_url, category.domain_rule_reference, category.domain_rule_url, target: '_blank' %></span>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>  
          </div>
        </div>
      </div>
    <% end %>

    <% if @test.has_practical_tasks? %>
      <div class="wrapper">
        <div class="page--header">
          <div class="row between-xs">
            <div class="col-xs-auto">
              <h2><%= t('.practical_tasks') %></h2>
            </div>
            <div class="col-xs-auto">
              <%= link_to t(:add_new), new_admin_test_practical_task_path(@test), 
                          class: 'button button--primary',
                          data: { 
                            turbo: true,
                            turbo_frame: "practical_task_form"
                          } %>
            </div>
          </div>
        </div>
        <% if @practical_tasks.any? %>
          <table class="table">
            <thead>
              <tr>
                <th width="5px"></th>
                <th><%= t('.task_body') %></th>
                <th><%= t('.task_status') %></th>
                <th class="table--action"></th>
              </tr>
            </thead>
            <tbody data-controller="drag" data-drag-url-value="<%= update_positions_admin_test_practical_tasks_path(@test) %>">
              <% @practical_tasks.each do |task| %>
                <tr class="item" data-id="<%= task.id %>" id="<%= dom_id(task) %>">
                  <td>
                    <div class="drag-handle">
                      <i class="fas fa-grip-vertical"></i>
                    </div>
                  </td>
                  <td>
                    <p><strong><%= task.title %></strong></p>
                    <p><%= task.body %></p>
                  </td>
                  <td>
                    <% if task.active? %>
                      <span class="label label-success"><%= t('.active') %></span>
                    <% else %>
                      <span class="label label-default"><%= t('.inactive') %></span>
                    <% end %>
                  </td>
                  <td class="table--action">
                    <%= icon_link_to 'fas fa-pencil-alt', edit_admin_test_practical_task_path(@test, task), 
                                    class: 'simple_tooltip', 
                                    data: { 
                                      'tippy-content': t(:edit),
                                      turbo: true,
                                      turbo_frame: "practical_task_form"
                                    } %>
                    <%= icon_link_to 'fas fa-trash-alt', admin_test_practical_task_path(@test, task), class: 'simple_tooltip', data: { 'tippy-content': t(:delete), turbo: true, turbo_method: :delete, turbo_confirm: t(:delete_confirmation) } %>
                  </td>
                </tr>
              <% end %>
              <tr>
                <td colspan="2">
                </td>
              </tr>
            </tbody>
          </table>
        <% else %>
          <p class="message message--info"><%= t('.no_practical_tasks') %></p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<%= render 'admin/practical_tasks/practical_task_dialog' %>