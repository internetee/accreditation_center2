<% content_for(:title) { "EIS | #{t('.title')}" } %>
<% content_for :hero do %>
<div class="layout--hero">
  <h1><%= t('.welcome_back', username: current_user.username || current_user.email) %></h1>
  <% if @accreditation_expires_soon %>
    <div class="hero--warning">
      <i class="fas fa-exclamation-triangle"></i>
      <%= t('.accreditation_expires_soon', days: @days_until_expiry) %>
    </div>
  <% end %>
</div>
<% end %>

<div class="page page--dashboard">
  <%= render 'common/top_grid' %>
  <!-- Statistics Overview -->
  <div class="wrapper">
    <div class="row">
      <div class="col-xs-12 col-md-12">
          <div class="paper">
            <div class="paper--content">
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-value"><%= @test_statistics[:total] %></div>
                  <div class="stat-label"><%= t('.total_attempts') %></div>
                </div>
                <div class="stat-item">
                  <div class="stat-value stat-success"><%= @test_statistics[:passed] %></div>
                  <div class="stat-label"><%= t('.passed_tests') %></div>
                </div>
                <div class="stat-item">
                  <div class="stat-value stat-danger"><%= @test_statistics[:failed] %></div>
                  <div class="stat-label"><%= t('.failed_tests') %></div>
                </div>
                <div class="stat-item">
                  <div class="stat-value"><%= @test_statistics[:success_rate] %>%</div>
                  <div class="stat-label"><%= t('.success_rate') %></div>
                </div>
              </div>
            </div>
          </div>
      </div>
    </div>
  </div>

  <div class="wrapper">
    <div class="page--header">
      <h2><%= t('.assigned_tests') %></h2>
    </div>
    <% if @assigned_tests.any? %>
      <table class="table">
        <thead>
          <tr>
            <th><%= t('.test') %></th>
            <th><%= t('.time_remaining') %></th>
            <th><%= t('.progress') %></th>
            <th><%= t('.actions') %></th>
          </tr>
        </thead>
        <tbody>
          <% @assigned_tests.each do |attempt| %>
            <% route_prefix = attempt.test.theoretical? ? :theoretical : :practical %>
            <tr>
              <td><%= attempt.test.title %></td>
              <td>
                <% if attempt.in_progress? %> 
                  <div class="time-remaining" data-controller="test-timer"
                       data-test-timer-remaining-value="<%= attempt.time_remaining %>"
                       data-time-template="<%= t('tests.time_remaining_short') %>"
                  >
                    <i class="fas fa-clock"></i>
                    <span class="time-text" data-test-timer-target="timeText">
                      <%= t('tests.time_remaining_short', minutes: (attempt.time_remaining / 60).floor, seconds: attempt.time_remaining % 60) %>
                    </span>
                  </div>
                <% else %>
                  <%= format_time(attempt.time_remaining) %>
                <% end %>
              </td>
              <td><%= attempt.progress_percentage %>%</td>
              <td>
                <% if attempt.in_progress? %>
                  <%= link_to t('.continue_test'),
                    send("question_#{route_prefix}_test_path", attempt.test, attempt: attempt.access_code, question_index: 0),
                    class: 'button button--link' %>
                <% elsif attempt.not_started? %>
                  <%= button_to t('.start_test'), 
                                send("start_#{route_prefix}_test_path", attempt.test, attempt: attempt.access_code), 
                                method: :post, 
                                class: 'button button--link' %>
                <% end %>
              </td>
            </tr>
          <% end %>
          <tr>
            <td colspan="4">
            </td>
          </tr>
        </tbody>
      </table>
    <% else %>
      <div class="page--message"><%= t('.no_tests_assigned') %></div>
    <% end %>
  </div>
 

  <% if @completed_tests.any? %>
    <div class="wrapper">
      <div class="page--header">
        <h2><%= t('.recent_history') %></h2>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th><%= t('.test') %></th>
            <th><%= t('.date') %></th>
            <th><%= t('.score') %></th>
            <th><%= t('.actions') %></th>
          </tr>
        </thead>
        <tbody>
          <% @completed_tests.each do |attempt| %>
            <% route_prefix = attempt.test.theoretical? ? :theoretical : :practical %>
            <tr>
              <td><%= attempt.test.title %></td>
              <td><%= l(attempt.completed_at.in_time_zone('EET'), format: :short) %></td>
              <td><%= attempt.score_percentage %>%</td>
              <td><%= link_to t('.view_results'), 
                          send("results_#{route_prefix}_test_path", attempt.test, attempt: attempt.access_code), 
                          class: 'button button--link' %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>